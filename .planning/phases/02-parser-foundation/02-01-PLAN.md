---
phase: 02-parser-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/articles.ts
  - tests/constraints/articles.test.ts
  - blog/articles/*.md
autonomous: true

must_haves:
  truths:
    - "gray-matter parses all 52 articles without errors"
    - "Roundtrip test (parse → stringify → re-parse) passes for every article with semantic equivalence"
    - "Schema validation rejects articles missing required fields (slug, title, description, date, status, coverImage, tags)"
    - "All articles have canonical YAML frontmatter (consistent key order, no line wrapping, block arrays)"
    - "Build (bun run pages:build) succeeds after parser swap"
    - "All existing tests pass after parser swap"
  artifacts:
    - path: "lib/articles.ts"
      provides: "gray-matter parser with Zod schema, replaces custom YAML parser"
      exports: ["ArticleFrontmatterSchema", "ArticleFrontmatter", "GRAY_MATTER_OPTIONS", "readArticle", "readAllArticles", "getAllContent"]
    - path: "tests/constraints/articles.test.ts"
      provides: "Permanent roundtrip fidelity + schema validation tests for all articles"
      contains: "Article Roundtrip Fidelity"
    - path: "blog/articles/*.md"
      provides: "52 articles reformatted with canonical YAML frontmatter"
  key_links:
    - from: "lib/articles.ts"
      to: "gray-matter"
      via: "matter() parse with yaml.JSON_SCHEMA engine"
      pattern: "matter\\(.*GRAY_MATTER_OPTIONS\\)"
    - from: "lib/articles.ts"
      to: "zod"
      via: "ArticleFrontmatterSchema.parse(data) at parse time"
      pattern: "ArticleFrontmatterSchema\\.parse"
    - from: "tests/constraints/articles.test.ts"
      to: "lib/articles.ts"
      via: "imports GRAY_MATTER_OPTIONS and ArticleFrontmatterSchema"
      pattern: "from.*lib/articles"
---

<objective>
Replace the custom YAML frontmatter parser in lib/articles.ts with gray-matter, define a canonical Zod schema for article frontmatter, reformat all 52 articles to canonical YAML, and add permanent roundtrip + schema validation tests.

Purpose: Reliable bidirectional frontmatter parsing is the foundation for the Supabase sync pipeline (Phase 4). The custom parser handles only basic YAML; gray-matter handles 100% of YAML correctly.
Output: Updated lib/articles.ts with gray-matter + Zod schema, reformatted articles, permanent test suite.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-parser-foundation/02-RESEARCH.md
@lib/articles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace custom parser with gray-matter + Zod schema and reformat all articles</name>
  <files>lib/articles.ts, blog/articles/*.md</files>
  <action>
In lib/articles.ts:

1. Add imports: `gray-matter`, `js-yaml`, `zod`.

2. Define the Zod schema (all 7 fields required, per research field survey):
   ```typescript
   export const ArticleFrontmatterSchema = z.object({
     slug: z.string(),
     title: z.string(),
     description: z.string(),
     date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
     status: z.enum(["published", "draft"]),
     coverImage: z.string().nullable(),
     tags: z.array(z.string()).nullable(),
   });
   export type ArticleFrontmatter = z.infer<typeof ArticleFrontmatterSchema>;
   ```

3. Configure gray-matter with yaml.JSON_SCHEMA engine (CRITICAL: prevents date coercion):
   ```typescript
   const YAML_ENGINE = {
     parse: (str: string) => yaml.load(str, { schema: yaml.JSON_SCHEMA }) as Record<string, unknown>,
     stringify: (data: Record<string, unknown>) => yaml.dump(data, {
       schema: yaml.JSON_SCHEMA,
       lineWidth: -1,
     }),
   };
   export const GRAY_MATTER_OPTIONS = { engines: { yaml: YAML_ENGINE } };
   ```

4. Define canonical key ordering helper:
   ```typescript
   const CANONICAL_KEY_ORDER = ["slug", "title", "description", "date", "status", "coverImage", "tags"] as const;
   function toCanonicalOrder(data: Record<string, unknown>): Record<string, unknown> { ... }
   ```

5. Export `stringifyArticle(frontmatter, content)` function using matter.stringify with canonical order.

6. DELETE the entire `parseFrontmatter()` function (lines 39-113 of current file).

7. Rewrite `readArticle()` to use gray-matter:
   - Parse with `matter(content, GRAY_MATTER_OPTIONS)`
   - Validate with `ArticleFrontmatterSchema.parse(data)` -- throws on missing required fields (per user decision: "Schema is enforced at parse time")
   - Convert `tags: null` to `tags: []` AFTER schema validation (the Article interface uses `string[]`, schema allows nullable)
   - Keep the same return shape (`Article` interface unchanged)

8. Keep `readAllArticles()` and `getAllContent()` unchanged (they call readArticle internally).

9. Keep the existing `Article` interface unchanged (it already matches the schema output).

After updating lib/articles.ts, reformat all 52 articles in one pass:
- Read each .md file in blog/articles/
- Parse with gray-matter + GRAY_MATTER_OPTIONS
- Reorder keys to canonical order via toCanonicalOrder()
- Stringify with matter.stringify() and write back
- This normalizes YAML formatting: consistent quoting, key order, null handling
- The 6 articles with `tags: null` stay as `tags: null` in the file (they are valid per schema; the parser converts to [] at runtime)

Run `bun run pages:build` to verify the build still works after the swap.
Run existing tests (`bun run test:constraints`) to verify nothing broke.
  </action>
  <verify>
    - `bun run pages:build` succeeds
    - `bun run test:constraints` passes (existing tests)
    - Manually spot-check 2-3 reformatted articles to confirm canonical YAML format
  </verify>
  <done>
    - Custom parseFrontmatter() function is deleted from lib/articles.ts
    - gray-matter with yaml.JSON_SCHEMA is the sole parser
    - Zod schema validates all articles at parse time
    - All 52 articles have canonical YAML frontmatter (consistent key order, no wrapping)
    - Build and existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add permanent roundtrip fidelity and schema validation tests</name>
  <files>tests/constraints/articles.test.ts</files>
  <action>
Create tests/constraints/articles.test.ts with permanent CI tests (per user decision: "Roundtrip validation is a permanent test in the test suite, runs on every CI build"):

1. Import from lib/articles.ts: `GRAY_MATTER_OPTIONS`, `ArticleFrontmatterSchema`
2. Import gray-matter directly for parse/stringify operations in tests
3. Read all .md files from blog/articles/ directory

Test cases:
- "all articles exist" -- expect file count >= 52
- For each article file:
  - "roundtrip: {filename}" -- parse with gray-matter, stringify back, re-parse, assert `reparsed.data` deep-equals `parsed.data` AND `reparsed.content.trim()` equals `parsed.content.trim()` (semantic equivalence with trimmed body match per user decision)
  - "schema valid: {filename}" -- parse with gray-matter, run ArticleFrontmatterSchema.safeParse(), assert success. On failure, format error as `{filename}: {path}: {message}` for clear diagnostics.

Use `describe("Article Roundtrip Fidelity", ...)` as the test suite name.
Use `bun:test` imports (describe, test, expect) -- matches existing test convention in this project.

Run the new tests: `bun test tests/constraints/articles.test.ts`
Also run all constraint tests: `bun run test:constraints`
  </action>
  <verify>
    - `bun test tests/constraints/articles.test.ts` passes (all roundtrip + schema tests green)
    - `bun run test:constraints` passes (new + existing tests)
  </verify>
  <done>
    - Roundtrip test passes for all 52 articles (parse → stringify → re-parse gives semantic equivalence)
    - Schema validation test passes for all 52 articles
    - Tests are permanent -- will run on every CI build going forward
  </done>
</task>

</tasks>

<verification>
1. `bun run pages:build` succeeds (full build pipeline works)
2. `bun run test:constraints` passes (all constraint tests including new roundtrip tests)
3. No custom YAML parsing code remains in lib/articles.ts (grep for "parseFrontmatter" returns nothing)
4. All 52 articles in blog/articles/ have canonical frontmatter key order: slug, title, description, date, status, coverImage, tags
5. gray-matter uses yaml.JSON_SCHEMA (dates stay as strings, not Date objects)
</verification>

<success_criteria>
- Custom YAML parser replaced with gray-matter + yaml.JSON_SCHEMA
- Zod schema defined and enforced at parse time for all 7 required fields
- Roundtrip fidelity test passes for all 52 articles (permanent CI test)
- All articles reformatted to canonical YAML
- Build and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-parser-foundation/02-01-SUMMARY.md`
</output>
