---
phase: 04-sync-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/sync-articles.ts
  - package.json
autonomous: true
requirements:
  - SYNC-01
  - SYNC-02
  - SYNC-03
  - SYNC-04
  - SYNC-05
  - SYNC-06

must_haves:
  truths:
    - "Running `bun run sync` exports all published Supabase articles to blog/articles/*.md"
    - "Running sync twice with no DB changes produces zero file writes on the second run"
    - "Running `bun run sync --dry-run` shows per-file actions without writing any files"
    - "A single article failure does not abort the sync — remaining articles still process"
    - "Articles without slugs get auto-generated slugs from their title"
    - "Orphaned local .md files (no DB match) are warned about but not deleted"
  artifacts:
    - path: "scripts/sync-articles.ts"
      provides: "DB-to-markdown sync script with hash-based diffing"
      min_lines: 120
    - path: "package.json"
      provides: "sync script alias"
      contains: "sync"
  key_links:
    - from: "scripts/sync-articles.ts"
      to: "lib/articles.ts"
      via: "import stringifyArticle, toCanonicalOrder, ArticleFrontmatter"
      pattern: "stringifyArticle"
    - from: "scripts/sync-articles.ts"
      to: "Supabase articles + article_tags + tags tables"
      via: "supabase.from('articles').select('*, article_tags(tags(name))')"
      pattern: "article_tags.*tags.*name"
    - from: "scripts/sync-articles.ts"
      to: "blog/articles/*.md"
      via: "writeFileSync with hash-gated writes"
      pattern: "writeFileSync"
---

<objective>
Build the `scripts/sync-articles.ts` script that exports all published articles from Supabase to `blog/articles/*.md` with SHA-256 hash-based diffing, dry-run mode, orphan detection, graceful error handling, and auto-slug generation.

Purpose: This is the critical reverse pipeline — where `import-articles.ts` pushes markdown→DB, this script pulls DB→markdown. It makes the database the single source of truth while keeping markdown files as build artifacts for the static site.

Output: Working `scripts/sync-articles.ts` invokable via `bun run sync` (or `bun run sync --dry-run`)
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sync-pipeline/04-RESEARCH.md
@lib/articles.ts
@scripts/import-articles.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync-articles.ts script</name>
  <files>scripts/sync-articles.ts</files>
  <action>
Create `scripts/sync-articles.ts` as the mirror of `import-articles.ts`. Follow the same structure: shebang, loadEnv(), Supabase service-role client, main() with error handling.

**Supabase query** — single query with nested join:
```typescript
const { data: rows, error } = await supabase
  .from("articles")
  .select("slug, title, description, content, status, date, cover_image, article_tags(tags(name))")
  .eq("status", "published");
```

**Row-to-Article transform:**
- `slug`: use `row.slug` if present; if null/empty, auto-generate via `slugify(row.title)` (SYNC-06)
- `title`: `row.title`
- `description`: `row.description`
- `content`: `(row.content ?? "").trim()` — trim to match readArticle() behavior
- `date`: `row.date` (DATE column returns "YYYY-MM-DD" string)
- `status`: `row.status` as published/draft (only published fetched, but type it correctly)
- `coverImage`: `row.cover_image` (null passes through correctly via JSON_SCHEMA)
- `tags`: `(row.article_tags ?? []).map(at => at.tags.name).sort()` — MUST sort for deterministic output

**Slugify function** (SYNC-06):
```typescript
function slugify(title: string): string {
  return title
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .slice(0, 80);
}
```

**Hash-based diffing** (SYNC-02):
- Import `createHash` from `node:crypto`, `readFileSync`/`writeFileSync`/`existsSync`/`readdirSync`/`mkdirSync` from `node:fs`
- For each article: generate markdown via `stringifyArticle(frontmatter, article.content)`, compute SHA-256 of generated string, compute SHA-256 of existing file (if exists), write only if hashes differ

**Deterministic frontmatter** (SYNC-03):
- Import `stringifyArticle` and `ArticleFrontmatter` from `../lib/articles.ts`
- `stringifyArticle()` already handles canonical key ordering and JSON_SCHEMA YAML engine — no extra work needed
- Build the ArticleFrontmatter object from the transformed row data and pass to `stringifyArticle(frontmatter, content)`

**Dry-run mode** (SYNC-04):
- Parse `--dry-run` from `process.argv`
- In dry-run: for each file, print action and reason but do NOT write. Example output:
  - `WRITE: my-article.md (content changed)`
  - `WRITE: new-article.md (new file)`
  - `SKIP: old-article.md (unchanged)`
  - `ORPHAN: deleted-article.md (not in database)`

**Orphan detection:**
- After processing all articles, read `blog/articles/` directory for `.md` files
- Compare local slugs against DB slugs via Set difference
- Print warning for each orphan: `ORPHAN: {slug}.md (exists locally but not in database)`
- Do NOT delete orphan files

**Error handling** (SYNC-05):
- Wrap each article in try/catch. On failure: log error with slug, increment error count, continue to next article
- Collect errors and print at end

**Summary line** (locked decision):
- Normal mode: `Synced {total} articles: {N} created, {N} updated, {N} unchanged, {N} orphaned`
  - Only include non-zero categories (except unchanged which always shows)
  - If errors > 0, also show `{N} errors`
- Dry-run mode: same format but prefixed with `Dry run` instead of `Synced`

**loadEnv():**
- Copy the exact `loadEnv()` function from `import-articles.ts` (reads `.env` manually)

**Ensure output directory exists:**
- `mkdirSync(articlesDir, { recursive: true })` before writing, in case `blog/articles/` doesn't exist
  </action>
  <verify>
Run `bun run scripts/sync-articles.ts --dry-run` — should connect to Supabase, fetch published articles, and print per-file actions without writing any files. Verify output includes action (WRITE/SKIP) and reason for each article, plus a summary line.
  </verify>
  <done>
`scripts/sync-articles.ts` exists, compiles without errors, connects to Supabase in dry-run mode, and prints per-file sync actions with a summary line.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire package.json and verify live sync</name>
  <files>package.json</files>
  <action>
**Add sync script to package.json:**
Add `"sync": "bun scripts/sync-articles.ts"` to the `scripts` section, after the `restore` entry.

**Verify live sync:**
1. Run `bun run sync` (live mode) — should write all 52 articles to `blog/articles/`
2. Run `bun run sync` again immediately — should report 0 updated, 52 unchanged (proves hash diffing works)
3. Run `bun run sync --dry-run` — should show all SKIP actions

**Verify build still works:**
Run `bun run build` to confirm the synced markdown files are valid and the build pipeline succeeds.

**Verify existing tests:**
Run `bun run test:constraints` to confirm roundtrip fidelity tests still pass with the synced files.
  </action>
  <verify>
1. `bun run sync` succeeds with summary showing articles synced
2. Second `bun run sync` shows 0 updated (all unchanged)
3. `bun run sync --dry-run` shows SKIP for all files
4. `bun run build` succeeds
5. `bun run test:constraints` passes
  </verify>
  <done>
`bun run sync` is a working command that exports Supabase articles to markdown. Hash diffing prevents unnecessary writes. Build pipeline and constraint tests pass with synced files.
  </done>
</task>

</tasks>

<verification>
1. `bun run sync --dry-run` prints per-file actions without writing
2. `bun run sync` writes articles to `blog/articles/*.md`
3. Running sync twice produces zero writes on second run (hash diffing)
4. `bun run build` succeeds with synced files
5. `bun run test:constraints` passes (roundtrip fidelity)
6. Summary line matches format: "Synced N articles: X updated, Y unchanged"
</verification>

<success_criteria>
- `scripts/sync-articles.ts` exists and runs without errors
- `bun run sync` exports all published articles from Supabase to `blog/articles/*.md`
- Hash-based diffing skips unchanged files (verified by consecutive syncs)
- Dry-run mode previews changes without file writes
- Orphaned files warned but not deleted
- Build pipeline works end-to-end with synced files
- Existing constraint tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-sync-pipeline/04-01-SUMMARY.md`
</output>
