---
phase: 05-integration-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [lib/article-helpers.ts]
autonomous: true
requirements: [AINT-01, AINT-02]

must_haves:
  truths:
    - "createArticle inserts an article into Supabase with created_by and updated_by set"
    - "updateArticle updates an article by slug with updated_by set"
    - "getArticleBySlug retrieves an article with its tags"
    - "All three functions handle tags via the delete + re-insert pattern"
    - "created_by and updated_by are required parameters (not optional), preventing 'unknown' defaults"
  artifacts:
    - path: "lib/article-helpers.ts"
      provides: "Article CRUD helper functions for AI agents"
      exports: ["createArticle", "updateArticle", "getArticleBySlug"]
      min_lines: 100
  key_links:
    - from: "lib/article-helpers.ts"
      to: "supabase.from('articles')"
      via: "service-role client"
      pattern: "from\\(['\"]articles['\"]\\)"
    - from: "lib/article-helpers.ts"
      to: "supabase.from('article_tags')"
      via: "tag management"
      pattern: "from\\(['\"]article_tags['\"]\\)"
    - from: "lib/article-helpers.ts"
      to: "supabase.from('tags')"
      via: "tag upsert"
      pattern: "from\\(['\"]tags['\"]\\)"
---

<objective>
Create TypeScript helper functions for AI agents to create, update, and retrieve articles in Supabase, with mandatory audit trail (created_by/updated_by) on all writes.

Purpose: Enable AI agents to manage articles programmatically through simple function imports, with full audit trail and tag management built in.
Output: lib/article-helpers.ts with createArticle, updateArticle, getArticleBySlug exports.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integration-verification/05-RESEARCH.md
@.planning/phases/03-supabase-schema-import/03-02-SUMMARY.md
@scripts/import-articles.ts
@lib/articles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create article-helpers.ts with CRUD functions and audit trail</name>
  <files>lib/article-helpers.ts</files>
  <action>
Create `lib/article-helpers.ts` with the following exports:

**1. `getServiceClient()` (internal helper)**
- Create a Supabase client using service role credentials
- Read `SUPABASE_URL` (fallback to `VITE_SUPABASE_URL`) and `SUPABASE_SERVICE_KEY` from `process.env`
- Configure with `{ auth: { persistSession: false, autoRefreshToken: false } }`
- Throw descriptive error if env vars missing
- Follow the exact same pattern used in `scripts/import-articles.ts` and `scripts/sync-articles.ts`

**2. `createArticle(input: CreateArticleInput): Promise<{ id: number; slug: string }>`**
- Interface `CreateArticleInput`: slug (string), title (string), description (string), content (string), date (string), status (optional, "draft" | "published", default "draft"), coverImage (optional string | null), tags (optional string[]), createdBy (REQUIRED string)
- Insert into articles table with `created_by` and `updated_by` both set to `createdBy`
- Map `coverImage` to `cover_image` column name
- After insert, if tags provided, call `upsertTags()` with the article ID
- Return `{ id, slug }` from the inserted row
- Throw on error with descriptive message

**3. `updateArticle(slug: string, input: UpdateArticleInput): Promise<{ id: number; slug: string }>`**
- Interface `UpdateArticleInput`: title, description, content, date, status, coverImage (all optional), tags (optional string[]), updatedBy (REQUIRED string)
- Update only the fields that are provided (not undefined)
- Always set `updated_by` to `updatedBy`
- Map `coverImage` to `cover_image`
- If `tags` is provided (even empty array), call `upsertTags()` to replace tags
- Return `{ id, slug }` from the updated row
- Throw on error with descriptive message

**4. `getArticleBySlug(slug: string): Promise<ArticleWithTags>`**
- Query articles table with `select("*, article_tags(tags(name))")` and `.eq("slug", slug).single()`
- Return the article data with nested tag names
- Throw on error (including not found)

**5. `upsertTags(supabase, articleId, tags)` (internal helper)**
- Copy the EXACT pattern from `scripts/import-articles.ts`:
  1. Delete all rows from `article_tags` where `article_id = articleId`
  2. If tags is empty, return early
  3. Upsert tag names into `tags` table with `onConflict: "name"`
  4. Fetch tag IDs by name from `tags` table
  5. Insert junction rows into `article_tags`
- Throw on any step failure

**Key requirements:**
- `createdBy` on createArticle and `updatedBy` on updateArticle are REQUIRED (not optional). This ensures audit columns are never left as 'unknown' default.
- Do NOT add a `loadEnv()` function. Callers are responsible for ensuring env vars are set (they may use different loading strategies).
- Import `createClient` from `@supabase/supabase-js` (already in dependencies).
- Export types: `CreateArticleInput`, `UpdateArticleInput` for consumers.
  </action>
  <verify>
1. `bun run check` (typecheck) passes with the new file
2. `grep "createdBy" lib/article-helpers.ts` confirms required audit field
3. `grep "updatedBy" lib/article-helpers.ts` confirms required audit field
4. `grep "export async function createArticle" lib/article-helpers.ts` confirms export
5. `grep "export async function updateArticle" lib/article-helpers.ts` confirms export
6. `grep "export async function getArticleBySlug" lib/article-helpers.ts` confirms export
7. `grep "article_tags" lib/article-helpers.ts` confirms tag management wiring
  </verify>
  <done>lib/article-helpers.ts exports createArticle, updateArticle, getArticleBySlug with required audit trail fields (createdBy/updatedBy), tag management via delete+re-insert pattern, and passes typecheck.</done>
</task>

</tasks>

<verification>
1. `bun run check` passes (TypeScript compiles without errors)
2. `grep -c "export async function" lib/article-helpers.ts` returns 3 (three exported functions)
3. `grep "createdBy.*string" lib/article-helpers.ts` confirms createdBy is typed as string (required)
4. `grep "updatedBy.*string" lib/article-helpers.ts` confirms updatedBy is typed as string (required)
</verification>

<success_criteria>
- createArticle, updateArticle, getArticleBySlug functions exist and are exported (AINT-01)
- created_by and updated_by are always populated via required parameters (AINT-02)
- Tag management follows proven delete + re-insert pattern from import-articles.ts
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-verification/05-02-SUMMARY.md`
</output>
